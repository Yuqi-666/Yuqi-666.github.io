{{/* Markdown Image Renderer for Hugo Blox Builder. */}}
{{/* 兼容 Obsidian Canvas 链接，不依赖 $.Site 上下文 */}}
{{/* Load image from page dir falling back to media library at `assets/media/` and then to remote URI. */}}

{{ $destination := .Destination }}
{{ $is_remote := strings.HasPrefix $destination "http" }}
{{ $caption := .Title | default "" }}
{{ $zoom := "true" }}
{{ $id := anchorize ($caption | plainify) }}
{{ $alt := .Text | default ($caption | plainify) }}
{{ $img_class := "" }}
{{ $fig_class := "" }}
{{ $max_width := "" }}
{{ $width := "" }}
{{ $height := "" }}
{{ $numbered := false }}

{{/* 判断是否为 Obsidian Canvas 链接（后缀为 .canvas） */}}
{{ $isCanvas := strings.HasSuffix $destination ".canvas" }}

{{/* Workaround Hugo v0.81 error on Windows when `resources.Get (path.Join "media" <URL>)` */}}
{{- $img := "" -}}
{{- if not $is_remote -}}
  {{- $img = (.Page.Resources.ByType "image").GetMatch $destination -}}
  {{- if not $img -}}
    {{- $img = resources.Get (path.Join "media" $destination) -}}
  {{- end -}}
{{- end -}}

{{/* Canvas 专属渲染逻辑（核心修复：不依赖 $.Site） */}}
{{ if $isCanvas }}
  {{- $canvasURL := "" -}}
  {{- if $is_remote -}}
    {{- $canvasURL = $destination | safeURL -}}{{/* 远程链接直接使用 */}}
  {{- else if $img -}}
    {{- $canvasURL = $img.RelPermalink -}}{{/* 本地资源（assets/media/）：用资源的相对路径（最可靠） */}}
  {{- else -}}
    {{/* 静态资源（static/目录）：通过 Page.RelPermalink 拼接，避免访问 Site */}}
    {{- $pageRelPath := .Page.RelPermalink -}}
    {{- /* 移除页面路径的文件名部分，保留目录路径 */}}
    {{- $pageDir := replace $pageRelPath (printf "%s/" .Page.File.BaseFileName) "" -}}
    {{- /* 拼接 Canvas 路径（处理斜杠，避免重复） */}}
    {{- if strings.HasSuffix $pageDir "/" -}}
      {{- $canvasURL = printf "%s%s" $pageDir $destination | absURL -}}
    {{- else -}}
      {{- $canvasURL = printf "%s/%s" $pageDir $destination | absURL -}}
    {{- end -}}
  {{- end -}}

  {{/* 生成唯一容器 ID（支持同一页面多个 Canvas） */}}
  {{ $containerId := printf "canvas-container-%s-%d" $id (now.UnixNano) }}

  {{/* 保留原 figure 结构，保持主题样式一致 */}}
  <figure {{ with $fig_class }}class="{{.}}"{{end}} {{ with $id }}id="figure-{{ . }}"{{ end }}>
    <div class="flex justify-center">
      <div class="w-full" {{ with $max_width }}style="max-width: {{.}}"{{end}}>
        {{/* Canvas 容器（继承宽高配置） */}}
        <div id="{{ $containerId }}" style="
          width: {{ $width | default "100%" }};
          height: {{ $height | default "600px" }};
          border: 1px solid #eee;
          border-radius: 4px;
          overflow: hidden;
        "></div>
      </div>
    </div>

    {{- if $caption -}}
      {{- $figure := split (i18n "figure" | default "Figure %d:") "%d" -}}
      <figcaption{{ if eq $numbered "true" }} data-pre="{{- trim (index $figure 0) " " -}}&nbsp;" data-post="{{ index $figure 1 }}&nbsp;" class="numbered"{{ end }}>
        {{ $caption | markdownify | emojify }}
      </figcaption>
    {{- end -}}
  </figure>

  {{/* 初始化 json-canvas-viewer */}}
  <script type="module">
    import { marked } from 'https://cdn.jsdelivr.net/npm/marked@12/+esm';
    import canvasViewer from 'https://cdn.jsdelivr.net/npm/json-canvas-viewer@1/+esm';
    import minimap from 'https://cdn.jsdelivr.net/npm/json-canvas-viewer@1/minimap/+esm';

    window.marked = marked;
    const container = document.getElementById('{{ $containerId }}');
    const viewer = new canvasViewer(container, {
      extensions: [minimap],
      options: { minimap: { collapsed: true }, zoom: { min: 0.1, max: 3 } },
      hooks: {
        onLoad: [(path) => console.log(`Canvas 加载成功：${path}`)],
        onError: [(err) => {
          console.error('Canvas 加载失败：', err);
          container.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #dc2626;">
            Canvas 加载失败（路径：${path}），请检查文件是否存在或路径是否正确
          </div>`;
        }]
      }
    });

    viewer.loadCanvas('{{ $canvasURL }}');
    window.addEventListener('beforeunload', () => viewer.dispose());
  </script>

{{/* 原有逻辑：非 Canvas 图片保持默认渲染 */}}
{{ else }}
  <figure {{ with $fig_class }}class="{{.}}"{{end}} {{ with $id }}id="figure-{{ . }}"{{ end }}>
    <div class="flex justify-center	">
      <div class="w-full" {{ with $max_width }}style="max-width: {{.}}"{{end}}>
        {{- if $img -}}
          {{- $isSVG := eq $img.MediaType.SubType "svg" -}}
          {{- $isGIF := eq $img.MediaType.SubType "gif" -}}
          {{- if $isSVG | or $isGIF -}}
            <img alt="{{ $alt }}"
             src="{{ $img.RelPermalink }}"
             loading="lazy"
             {{- if $zoom }} data-zoomable{{end}}
             {{- with $width }} width="{{.}}"{{end}}
             {{- with $height }} height="{{.}}"{{end}}
             {{- with $img_class }} class="{{.}}"{{end}} />
          {{- else }}
            {{- $img_md := $img.Fit "760x760 webp" -}}
            {{- $responsive := partial "functions/process_responsive_image.html" (dict "image" $img_md "mode" "responsive") -}}
            {{- $width := $width | default $img_md.Width -}}
            {{- $height := $height | default $img_md.Height -}}
            <img alt="{{ $alt }}" 
                 srcset="{{ $responsive.srcset }}"
                 sizes="(max-width: 480px) 100vw, (max-width: 768px) 90vw, (max-width: 1024px) 80vw, 760px"
                 src="{{ $responsive.fallback.RelPermalink }}"
                 width="{{ $width }}"
                 height="{{ $height }}"
                 loading="lazy"
                 {{- if $zoom }} data-zoomable{{end}}
                 {{- with $img_class }} class="{{.}}"{{end}} />
          {{- end }}
        {{- else -}}
          <img src="{{ $destination | safeURL }}" alt="{{ $alt }}" loading="lazy" {{ if $zoom }}data-zoomable{{end}}
               {{- with $width }} width="{{.}}"{{end}} {{- with $height }} height="{{.}}"{{end}}
               {{- with $img_class }} class="{{.}}"{{end}} />
        {{- end -}}
      </div>
    </div>

    {{- if $caption -}}
      {{- $figure := split (i18n "figure" | default "Figure %d:") "%d" -}}
      <figcaption{{ if eq $numbered "true" }} data-pre="{{- trim (index $figure 0) " " -}}&nbsp;" data-post="{{ index $figure 1 }}&nbsp;" class="numbered"{{ end }}>
        {{ $caption | markdownify | emojify }}
      </figcaption>
    {{- end -}}
  </figure>
{{ end }}